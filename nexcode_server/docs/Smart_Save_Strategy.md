# 智能保存策略

## 概述

智能保存策略是為了解決頻繁保存導致的性能問題而設計的。它根據內容變化、時間間隔和句子完成情況來智能決定何時保存文檔，既保證了數據安全，又提高了系統性能。

## 保存觸發條件

### 1. 時間間隔觸發
- **間隔時間**：10秒
- **觸發條件**：距離上次保存超過10秒
- **特點**：即使內容沒有變化也會觸發，確保定期保存

### 2. 內容變化觸發
- **最小變化閾值**：10個字符
- **觸發條件**：內容變化超過10個字符
- **特點**：避免小幅度修改導致的頻繁保存

### 3. 句子完成觸發
- **句子結束標記**：`.`, `!`, `?`, `。`, `！`, `？`, `\n`
- **觸發條件**：新增內容以句子結束標記結尾
- **特點**：在用戶完成一個完整句子時保存，符合寫作習慣

## 技術實現

### 核心組件

#### DocumentStorageService
```python
class DocumentStorageService:
    def __init__(self):
        self.save_interval = 10.0  # 10秒保存間隔
        self.min_content_change = 10  # 最小內容變化字符數
        self.sentence_endings = ['.', '!', '?', '。', '！', '？', '\n']  # 句子結束標記
        self.document_states = {}  # 文檔狀態追蹤
```

#### 智能判斷邏輯
```python
def _should_save_document(self, document_id: int, content: str) -> bool:
    # 檢查時間間隔
    if (current_time - state["last_save"]).total_seconds() >= self.save_interval:
        return True
    
    # 檢查內容變化
    if content_diff >= self.min_content_change:
        return True
    
    # 檢查句子完成
    if self._is_sentence_complete(state["last_content"], content):
        return True
    
    return False
```

### 異步處理

- **後台隊列**：使用 `asyncio.Queue` 處理保存請求
- **非阻塞**：保存操作不會阻塞用戶編輯
- **錯誤處理**：保存失敗時會記錄錯誤但不影響用戶操作

## 使用場景

### 1. 單人編輯
- 用戶正常寫作時，系統會在句子完成時自動保存
- 長時間編輯時，每10秒自動保存一次
- 大量修改時，超過10個字符變化立即保存

### 2. 協作編輯
- 多個用戶同時編輯時，每個用戶的修改都會觸發智能保存
- 會話感知廣播，避免同一用戶的多個標籤頁收到自己的消息
- 實時同步其他用戶的修改

### 3. 版本管理
- 每次保存都會創建一個新版本
- 保留完整的修改歷史
- 支持版本回滾和比較

## 配置參數

可以根據需要調整以下參數：

```python
# 保存間隔（秒）
save_interval = 10.0

# 最小內容變化字符數
min_content_change = 10

# 句子結束標記
sentence_endings = ['.', '!', '?', '。', '！', '？', '\n']
```

## 性能優勢

### 1. 減少數據庫負載
- 避免每次按鍵都保存
- 智能合併保存請求
- 異步處理減少阻塞

### 2. 提升用戶體驗
- 編輯流暢，無卡頓
- 自動保存，無需手動操作
- 實時協作，即時同步

### 3. 數據安全
- 定期保存，防止數據丟失
- 句子級保存，符合寫作習慣
- 版本管理，支持回滾

## 測試結果

### 測試場景
- 單人編輯測試
- 協作編輯測試
- 句子完成測試
- 時間間隔測試

### 測試結果
- ✅ 初始保存正常
- ✅ 大變化觸發正常
- ✅ 句子完成觸發正常
- ✅ 時間間隔觸發正常
- ✅ 避免重複保存
- ✅ 異步處理正常

## 未來改進

### 1. 自適應間隔
- 根據用戶編輯習慣調整保存間隔
- 學習用戶的寫作模式

### 2. 智能壓縮
- 合併相似的保存請求
- 減少版本數量

### 3. 雲端同步
- 支持離線編輯
- 網絡恢復時自動同步

## 總結

智能保存策略成功解決了頻繁保存導致的性能問題，同時保證了數據安全和用戶體驗。通過時間間隔、內容變化和句子完成三個維度的智能判斷，系統能夠在合適的時機進行保存，既避免了數據丟失，又提升了系統性能。 